{"version":3,"file":"WebpackRemoveOldAssetsPlugin.js","sourceRoot":"","sources":["../../src/plugins/WebpackRemoveOldAssetsPlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { lstat, readdir, remove, Stats } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { Compiler } from \"webpack\"\nimport { orNullIfFileNotExist } from \"../util\"\n\nexport const MAX_FILE_REQUESTS = 8\nexport const CONCURRENCY = {concurrency: MAX_FILE_REQUESTS}\n\nconst debug = require(\"debug\")(\"electron-webpack:clean\")\n\nexport async function walk(initialDirPath: string, filter?: Filter | null): Promise<Array<string>> {\n  const result: Array<string> = []\n  const queue: Array<string> = [initialDirPath]\n  let addDirToResult = false\n  while (queue.length > 0) {\n    const dirPath = queue.pop()!\n\n    const childNames = await orNullIfFileNotExist(readdir(dirPath))\n    if (childNames == null) {\n      continue\n    }\n\n    if (addDirToResult) {\n      result.push(dirPath)\n    }\n    else {\n      addDirToResult = true\n    }\n\n    childNames.sort()\n\n    const dirs: Array<string> = []\n    // our handler is async, but we should add sorted files, so, we add file to result not in the mapper, but after map\n    const sortedFilePaths = await BluebirdPromise.map(childNames, name => {\n      const filePath = dirPath + path.sep + name\n      return lstat(filePath)\n        .then(stat => {\n          if (filter != null && !filter(filePath, stat)) {\n            return null\n          }\n\n          if (stat.isDirectory()) {\n            dirs.push(name)\n            return null\n          }\n          else {\n            return filePath\n          }\n        })\n    }, CONCURRENCY)\n\n    for (const child of sortedFilePaths) {\n      if (child != null) {\n        result.push(child)\n      }\n    }\n\n    dirs.sort()\n    for (const child of dirs) {\n      queue.push(dirPath + path.sep + child)\n    }\n  }\n\n  return result\n}\n\nexport type Filter = (file: string, stat: Stats) => boolean\n\nexport class WebpackRemoveOldAssetsPlugin {\n  constructor(private readonly dllManifest: string | null) {\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.afterEmit.tapAsync(\"WebpackRemoveOldAssetsPlugin\", (compilation: any, callback: (error?: Error) => void) => {\n      const newlyCreatedAssets = compilation.assets\n      const outDir = compiler.options.output!.path!\n      walk(outDir, (file, stat) => {\n        // dll plugin\n        if (file === this.dllManifest) {\n          return false\n        }\n\n        const relativePath = file.substring(outDir.length + 1)\n        if (stat.isFile()) {\n          return newlyCreatedAssets[relativePath] == null\n        }\n        else if (stat.isDirectory()) {\n          for (const p of Object.keys(newlyCreatedAssets)) {\n            if (p.length > relativePath.length && (p[relativePath.length] === \"/\" || p[relativePath.length] === \"\\\\\") && p.startsWith(relativePath)) {\n              return false\n            }\n          }\n          return true\n        }\n        return false\n      })\n        .then((it): any => {\n          if (it.length === 0) {\n            return null\n          }\n\n          if (debug.enabled) {\n            debug(`Remove outdated files:\\n  ${it.join(\"\\n  \")}`)\n          }\n          return BluebirdPromise.map(it, it => remove(it), CONCURRENCY)\n        })\n        .then(() => callback())\n        .catch(callback)\n    })\n  }\n}\n"]}
