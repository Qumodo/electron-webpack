{"version":3,"file":"BaseTarget.js","sourceRoot":"","sources":["../../src/targets/BaseTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from \"path\"\nimport { DefinePlugin, EnvironmentPlugin, HotModuleReplacementPlugin, LoaderOptionsPlugin } from \"webpack\"\nimport { configureDll } from \"../configurators/dll\"\nimport { configureEslint } from \"../configurators/eslint\"\nimport { createBabelLoader } from \"../configurators/js\"\nimport { WebpackConfigurator } from \"../main\"\nimport { WatchFilterPlugin } from \"../plugins/WatchMatchPlugin\"\nimport { WebpackRemoveOldAssetsPlugin } from \"../plugins/WebpackRemoveOldAssetsPlugin\"\n\nexport class BaseTarget {\n  configureRules(configurator: WebpackConfigurator): void {\n    const rules = configurator.rules\n\n    const babelLoader = createBabelLoader(configurator)\n    if (configurator.type !== \"main\" && configurator.hasDependency(\"iview\")) {\n      rules.push({\n        test: /iview.src.*?js$/,\n        use: babelLoader\n      })\n    }\n\n    rules.push(\n      {\n        test: /\\.js$/,\n        exclude: /(node_modules|bower_components)/,\n        use: babelLoader\n      },\n      {\n        test: /\\.node$/,\n        use: \"node-loader\"\n      },\n    )\n\n    if (configurator.hasDevDependency(\"nunjucks-loader\")) {\n      rules.push({\n        test: /\\.(njk|nunjucks)$/,\n        loader: \"nunjucks-loader\"\n      })\n    }\n\n    configureEslint(configurator)\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    const plugins = configurator.plugins\n\n    const dllManifest = await configureDll(configurator)\n    const mode = configurator.isProduction ? \"production\" : \"development\"\n\n    let optimization = configurator.config.optimization\n    if (optimization == null) {\n      optimization = {}\n      configurator.config.optimization = optimization\n    }\n\n    optimization.nodeEnv = mode\n    configurator.config.mode = mode\n\n    if (configurator.isProduction) {\n      if (configurator.env.minify !== false) {\n        const UglifyJsPlugin = require(\"uglifyjs-webpack-plugin\")\n        plugins.push(new UglifyJsPlugin({\n          parallel: true,\n          sourceMap: true,\n          uglifyOptions: {\n            compress: {\n              ecma: 7,\n            },\n          },\n        }))\n      }\n      optimization.minimize = true\n      plugins.push(new LoaderOptionsPlugin({minimize: true}))\n\n      // do not use ModuleConcatenationPlugin for HMR\n      // https://github.com/webpack/webpack-dev-server/issues/949\n      optimization.concatenateModules = true\n    }\n    else {\n      configureDevelopmentPlugins(configurator)\n    }\n\n    if (configurator.env.autoClean !== false) {\n      plugins.push(new WebpackRemoveOldAssetsPlugin(dllManifest))\n    }\n\n    optimization.noEmitOnErrors = true\n\n    const additionalEnvironmentVariables = Object.keys(process.env).filter(it => it.startsWith(\"ELECTRON_WEBPACK_\"))\n    if (additionalEnvironmentVariables.length > 0) {\n      plugins.push(new EnvironmentPlugin(additionalEnvironmentVariables))\n    }\n  }\n}\n\nexport function configureFileLoader(prefix: string, limit = 10 * 1024) {\n  return {\n    limit,\n    name: `${prefix}/[name]--[folder].[ext]`\n  }\n}\n\nfunction isAncestor(file: string, dir: string) {\n  return file.length > dir.length && file[dir.length] === path.sep && file.startsWith(dir)\n}\n\nfunction configureDevelopmentPlugins(configurator: WebpackConfigurator) {\n  const plugins = configurator.plugins\n  configurator.config.optimization!!.namedModules = true\n  plugins.push(new DefinePlugin({\n    __static: `\"${path.join(configurator.projectDir, \"static\").replace(/\\\\/g, \"\\\\\\\\\")}\"`\n  }))\n\n  plugins.push(new HotModuleReplacementPlugin())\n\n  if (configurator.hasDevDependency(\"webpack-build-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-build-notifier\")\n    plugins.push(new WebpackNotifierPlugin({\n      title: `Webpack - ${configurator.type}`,\n      suppressSuccess: \"initial\",\n      sound: false,\n    }))\n  }\n\n  if (configurator.hasDevDependency(\"webpack-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-notifier\")\n    plugins.push(new WebpackNotifierPlugin({title: `Webpack - ${configurator.type}`}))\n  }\n\n  // watch common code\n  let commonSourceDir = configurator.electronWebpackConfiguration.commonSourceDirectory\n  if (commonSourceDir == null) {\n    // not src/common, because it is convenient to just put some code into src to use it\n    commonSourceDir = path.join(configurator.projectDir, \"src\")\n  }\n\n  const alienSourceDir = configurator.getSourceDirectory(configurator.type === \"main\" ? \"renderer\" : \"main\")\n\n  configurator.plugins.push(new WatchFilterPlugin(file => {\n    return file === commonSourceDir || (isAncestor(file, commonSourceDir!!) && (alienSourceDir != null && !file.startsWith(alienSourceDir)))\n  }, require(\"debug\")(`electron-webpack:watch-${configurator.type}`)))\n}\n"]}
