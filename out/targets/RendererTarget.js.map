{"version":3,"file":"RendererTarget.js","sourceRoot":"","sources":["../../src/targets/RendererTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import { outputFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { getConfig } from \"read-config-file\"\nimport { DefinePlugin } from \"webpack\"\nimport { getDllAssets } from \"../configurators/dll\"\nimport { configureVueRenderer } from \"../configurators/vue/vue\"\nimport { WebpackConfigurator } from \"../main\"\nimport { statOrNull } from \"../util\"\nimport { BaseTarget, configureFileLoader } from \"./BaseTarget\"\n\nconst ExtractTextPlugin = require(\"extract-text-webpack-plugin\")\n\nexport class BaseRendererTarget extends BaseTarget {\n  constructor() {\n    super()\n  }\n\n  configureRules(configurator: WebpackConfigurator): void {\n    super.configureRules(configurator)\n\n    configurator.extensions.push(\".css\")\n\n    const cssHotLoader = configurator.isProduction ? [] : [\"css-hot-loader\"]\n    if (!configurator.isProduction) {\n      // https://github.com/shepherdwind/css-hot-loader/issues/37\n      configurator.entryFiles.unshift(\"css-hot-loader/hotModuleReplacement\")\n    }\n\n    configurator.rules.push(\n      {\n        test: /\\.css$/,\n        use: cssHotLoader.concat(ExtractTextPlugin.extract({\n          use: \"css-loader\",\n          fallback: \"style-loader\",\n        })),\n      },\n      {\n        test: /\\.less$/,\n        use: cssHotLoader.concat(ExtractTextPlugin.extract({\n          use: [\n            {loader: \"css-loader\"},\n            {loader: \"less-loader\"}\n          ],\n          fallback: \"style-loader\"\n        }))\n      },\n      {\n        test: /\\.scss/,\n        use: cssHotLoader.concat(ExtractTextPlugin.extract({\n          use: [\n            {loader: \"css-loader\"},\n            {loader: \"sass-loader\"}\n          ],\n          fallback: \"style-loader\"\n        }))\n      },\n      {\n        test: /\\.(png|jpe?g|gif|svg)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"imgs\")\n        }\n      },\n      {\n        test: /\\.(mp4|webm|ogg|mp3|wav|flac|aac)(\\?.*)?$/,\n        loader: \"url-loader\",\n        options: configureFileLoader(\"media\"),\n      },\n      {\n        test: /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"fonts\")\n        }\n      },\n    )\n\n    if (configurator.hasDevDependency(\"ejs-html-loader\")) {\n      configurator.rules.push({\n        test: /\\.ejs$/,\n        loader: \"ejs-html-loader\",\n      })\n    }\n\n    if (configurator.hasDependency(\"vue\")) {\n      configureVueRenderer(configurator)\n    }\n    else {\n      configurator.rules.push({\n        test: /\\.(html)$/,\n        use: {\n          loader: \"html-loader\",\n        }\n      })\n    }\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    configurator.debug(\"Add ExtractTextPlugin plugin\")\n    configurator.plugins.push(new ExtractTextPlugin(`${configurator.type === \"renderer-dll\" ? \"vendor\" : \"styles\"}.css`))\n\n    // https://github.com/electron-userland/electrify/issues/1\n    if (!configurator.isProduction) {\n      configurator.plugins.push(new DefinePlugin({\n        \"process.env.NODE_ENV\": \"\\\"development\\\"\",\n      }))\n    }\n\n    await BaseTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nexport class RendererTarget extends BaseRendererTarget {\n  constructor() {\n    super()\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    // not configurable for now, as in the electron-vue\n    const customTemplateFile = path.join(configurator.projectDir, \"src/index.ejs\")\n    const HtmlWebpackPlugin = require(\"html-webpack-plugin\")\n    const nodeModulePath = configurator.isProduction ? null : path.resolve(configurator.projectDir, \"node_modules\")\n\n    configurator.plugins.push(new HtmlWebpackPlugin({\n      filename: \"index.html\",\n      template: (await statOrNull(customTemplateFile)) == null ? (await generateIndexFile(configurator, nodeModulePath)) : customTemplateFile,\n      minify: false,\n      nodeModules: nodeModulePath\n    }))\n\n    if (configurator.isProduction) {\n      configurator.plugins.push(new DefinePlugin({\n        __static: `\"${path.join(configurator.projectDir, \"static\").replace(/\\\\/g, \"\\\\\\\\\")}\"`\n      }))\n    }\n    else {\n      const contentBase = [path.join(configurator.projectDir, \"static\"), path.join(configurator.commonDistDirectory, \"renderer-dll\")]\n      configurator.config.devServer = {\n        contentBase,\n        host: process.env.ELECTRON_WEBPACK_WDS_HOST || \"localhost\",\n        port: process.env.ELECTRON_WEBPACK_WDS_PORT || 9080,\n        hot: true,\n        overlay: true,\n      }\n    }\n\n    await BaseRendererTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nasync function computeTitle(configurator: WebpackConfigurator): Promise<string | null | undefined> {\n  const titleFromOptions = configurator.electronWebpackConfiguration.title\n  if (titleFromOptions == null || titleFromOptions === false) {\n    return null\n  }\n\n  if (titleFromOptions !== true) {\n    return titleFromOptions\n  }\n\n  let title: string | null | undefined = (configurator.metadata as any).productName\n  if (title == null) {\n    const electronBuilderConfig = await getConfig<any>({\n      packageKey: \"build\",\n      configFilename: \"electron-builder\",\n      projectDir: configurator.projectDir,\n      packageMetadata: new Lazy(() => Promise.resolve(configurator.metadata))\n    })\n    if (electronBuilderConfig != null) {\n      title = electronBuilderConfig.result.productName\n    }\n  }\n\n  if (title == null) {\n    title = configurator.metadata.name\n  }\n  return title\n}\n\nasync function generateIndexFile(configurator: WebpackConfigurator, nodeModulePath: string | null) {\n  // do not use add-asset-html-webpack-plugin - no need to copy vendor files to output (in dev mode will be served directly, in production copied)\n  const assets = await getDllAssets(path.join(configurator.commonDistDirectory, \"renderer-dll\"), configurator)\n  const scripts: Array<string> = []\n  const css: Array<string> = []\n  for (const asset of assets) {\n    if (asset.endsWith(\".js\")) {\n      scripts.push(`<script type=\"text/javascript\" src=\"${asset}\"></script>`)\n    }\n    else {\n      css.push(`<link rel=\"stylesheet\" href=\"${asset}\">`)\n    }\n  }\n\n  const title = await computeTitle(configurator)\n  const filePath = path.join(configurator.commonDistDirectory, \".renderer-index-template.html\")\n  await outputFile(filePath, `<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"utf-8\">\n    ${title == null ? \"\" : `<title>${title}</title>`}\n    <script>\n      ${nodeModulePath == null ? \"\" : `require(\"module\").globalPaths.push(\"${nodeModulePath.replace(/\\\\/g, \"\\\\\\\\\")}\")`}\n      require(\"source-map-support/source-map-support.js\").install()\n    </script>\n    ${scripts.join(\"\")}\n  ${css.join(\"\")}\n  </head>\n  <body>\n    <div id=\"app\"></div>\n  </body>\n</html>`)\n\n  return `!!html-loader?minimize=false!${filePath}`\n}"]}
